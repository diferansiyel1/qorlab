name: Antigravity Cross-Platform CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main", "develop" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -----------------------------------------------------------------
  # PHASE 1: CODE INTEGRITY (AI & Logic Check)
  # Bu aÅŸama geÃ§ilmeden Build aÅŸamasÄ±na asla geÃ§ilmez.
  # -----------------------------------------------------------------
  integrity-check:
    name: ğŸ›¡ï¸ Logic & Architecture Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      # AI'Ä±n bozup bozmadÄ±ÄŸÄ±nÄ± kontrol eden en kritik adÄ±m
      - name: ğŸ•µï¸ Static Analysis (Strict)
        run: flutter analyze --no-fatal-infos

      # Fizik motoru ve hesaplama testleri
      - name: ğŸ§ª Unit Tests
        run: flutter test packages/core/physics_engine

  # -----------------------------------------------------------------
  # PHASE 2: ANDROID BUILD
  # -----------------------------------------------------------------
  build-android:
    needs: integrity-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - run: flutter pub get
      - run: flutter build appbundle --release
      
      - uses: actions/upload-artifact@v4
        with:
          name: android-bundle
          path: build/app/outputs/bundle/release/app-release.aab

  # -----------------------------------------------------------------
  # PHASE 3: iOS BUILD (MacOS Runner)
  # Not: Bu aÅŸamanÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in Apple Developer HesabÄ± sertifikalarÄ±nÄ±n
  # GitHub Secrets'a eklenmesi gerekir.
  # -----------------------------------------------------------------
  build-ios:
    needs: integrity-check
    runs-on: macos-latest # iOS iÃ§in zorunlu
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
      
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      # iOS Build (Ä°mzasÄ±z - Test amaÃ§lÄ±)
      # App Store daÄŸÄ±tÄ±mÄ± iÃ§in 'fastlane' entegrasyonu gereklidir.
      - name: ğŸ Build iOS (No Code Sign)
        run: flutter build ios --release --no-codesign

      # Not: Codesign olmadan .ipa Ã¼retilmez, sadece .app Ã¼retilir.
      # Otomasyon iÃ§in Fastlane match kullanÄ±mÄ± Ã¶nerilir.